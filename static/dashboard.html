<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Betten-Button Dashboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;min-width:280px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #ddd;display:inline-block}
    .ok{border-color:#9ad09a}
    .bad{border-color:#e5a0a0}
    .muted{color:#666}
    .big{font-size:28px;font-weight:700}
    .btn{cursor:pointer;border:1px solid #ddd;border-radius:10px;padding:10px 12px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="big">Betten-Button Dashboard</div>
      <div class="muted">Live-Status via <code>GET /devices</code> (Polling)</div>
    </div>
    <div class="row">
      <span id="health" class="pill">API: …</span>
      <button class="btn" onclick="refreshNow()">Jetzt aktualisieren</button>
    </div>
  </div>

  <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

  <div class="row">
    <span class="pill">Polling: <b id="pollMs">1000</b> ms</span>
    <button class="btn" onclick="setPoll(500)">0,5s</button>
    <button class="btn" onclick="setPoll(1000)">1s</button>
    <button class="btn" onclick="setPoll(2000)">2s</button>
    <span class="pill">Letztes Update: <b id="lastFetch">—</b></span>
  </div>

  <div style="margin:14px 0" class="grid" id="cards"></div>

  <script>
    const API_BASE = ""; // leer = gleiche Domain (Render)
    let POLL_MS = 1000;
    let timer = null;

    function statusLabel(s){
      if (s === 0) return "0 · Rot (keine Verfügbarkeit)";
      if (s === 1) return "1 · Grün 1 (heute verfügbar)";
      if (s === 2) return "2 · Grün 1+2 (mehrere Tage)";
      return String(s);
    }

    function fmtTime(iso){
      if(!iso) return "—";
      try {
        const d = new Date(iso);
        return d.toLocaleString("de-DE");
      } catch(e){ return iso; }
    }

    function render(devices){
      const root = document.getElementById("cards");
      root.innerHTML = "";
      if(!Array.isArray(devices) || devices.length===0){
        root.innerHTML = `<div class="card"><b>Keine Geräte gefunden</b><div class="muted">Antwort war leer.</div></div>`;
        return;
      }

      for(const d of devices){
        const s = d.status;
        const pillClass = (s===0) ? "bad" : "ok";
        const last = d.lastUpdate || d.timestamp || d.last_update || d.updated_at;
        const source = d.source || "—";
        root.insertAdjacentHTML("beforeend", `
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div><b>${d.device_id || d.id || "unknown"}</b></div>
              <span class="pill ${pillClass}">Status: <b>${statusLabel(s)}</b></span>
            </div>
            <div class="muted" style="margin-top:10px">
              Last update: <b>${fmtTime(last)}</b><br/>
              Source: <b>${source}</b>
            </div>
          </div>
        `);
      }
    }

    async function fetchDevices(){
      const health = document.getElementById("health");
      try{
        const res = await fetch(API_BASE + "/devices", { cache: "no-store" });
        if(!res.ok){
          health.textContent = `API: ${res.status}`;
          health.className = "pill bad";
          render([]);
          return;
        }
        const data = await res.json();
        health.textContent = "API: OK";
        health.className = "pill ok";

        document.getElementById("lastFetch").textContent = new Date().toLocaleTimeString("de-DE");
        render(data);
      }catch(e){
        health.textContent = "API: offline";
        health.className = "pill bad";
      }
    }

    function setPoll(ms){
      POLL_MS = ms;
      document.getElementById("pollMs").textContent = String(ms);
      if(timer) clearInterval(timer);
      timer = setInterval(fetchDevices, POLL_MS);
      fetchDevices();
    }

    function refreshNow(){ fetchDevices(); }

    setPoll(POLL_MS);
  </script>
</body>
</html>

