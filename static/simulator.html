<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bettenbutton â€“ Simulator (PRESS-Mode)</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    /* Falls styles.css fehlt, bleibt es trotzdem nutzbar */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap: wrap; margin-bottom: 16px; }
    .btn { padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor:not-allowed; }
    .btn.primary { font-weight: 700; }
    .pill { border-radius: 999px; padding: 6px 10px; border: 1px solid #ddd; background:#fafafa; font-size: 12px; }
    .muted { color:#666; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; vertical-align: top; text-align: left; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: .04em; color:#444; }
    .rowTitle { font-weight: 700; }
    .statusBadge { display:inline-flex; align-items:center; gap:8px; padding: 4px 10px; border:1px solid #ddd; border-radius: 999px; background:#fff; font-size: 12px;}
    .dot { width:10px; height:10px; border-radius: 999px; display:inline-block; border:1px solid #ddd; }
    .dot.red { background: #f44336; border-color:#f44336; }
    .dot.green { background:#4caf50; border-color:#4caf50; }
    .dot.gray { background:#bbb; border-color:#bbb; }
    .btnGroup { display:flex; gap:8px; flex-wrap: wrap; }
    .keyInput { padding: 8px 10px; border-radius: 999px; border: 1px solid #ccc; font-size: 12px; width: 220px; }
    .statusMsg { margin-top: 6px; font-size: 12px; }
    .statusMsg.ok { color: #1b5e20; }
    .statusMsg.err { color: #b71c1c; }
    .right { display:flex; align-items:center; gap: 10px; margin-left: auto; }
    code { background:#f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Bettenbutton â€“ Simulator</h1>
  <div class="muted">
    Dieser Simulator arbeitet wie die Hardware: Er sendet ausschlieÃŸlich <code>POST /devices/{id}/press</code>.
    (Kein direktes Setzen von Statuswerten.)
  </div>

  <div class="topbar">
    <button id="btnReload" class="btn primary">ðŸ”„ GerÃ¤te laden</button>
    <span id="conn" class="pill">Bereit</span>

    <div class="right">
      <span class="muted">API-Basis:</span>
      <code id="apiBase"></code>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width: 180px;">GerÃ¤t</th>
        <th style="width: 220px;">Aktueller Status</th>
        <th style="width: 260px;">X-Device-Key</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="4" class="muted">Noch keine Daten. Klicke â€žGerÃ¤te ladenâ€œ.</td></tr>
    </tbody>
  </table>
</div>

<script>
  // Basis: gleiches Origin wie Backend
  const API_BASE = "";
  document.getElementById("apiBase").textContent = (location.origin + "/");

  const connEl = document.getElementById("conn");
  const rowsEl = document.getElementById("rows");
  const btnReload = document.getElementById("btnReload");

  function setConn(text, ok=true) {
    connEl.textContent = text;
    connEl.style.borderColor = ok ? "#c8e6c9" : "#ffcdd2";
    connEl.style.background = ok ? "#e8f5e9" : "#ffebee";
  }

  function statusToLabel(s) {
    if (s === 0) return "ðŸ”´ Keine VerfÃ¼gbarkeit";
    if (s === 1) return "ðŸŸ¢ Heute verfÃ¼gbar";
    if (s === 2) return "ðŸŸ¢ðŸŸ¢ Mehrere Tage verfÃ¼gbar";
    return "Unbekannt";
  }

  function statusToDots(s) {
    // Visual: rot / grÃ¼n / grÃ¼n+grÃ¼n
    if (s === 0) return `<span class="dot red"></span>`;
    if (s === 1) return `<span class="dot green"></span>`;
    if (s === 2) return `<span class="dot green"></span><span class="dot green"></span>`;
    return `<span class="dot gray"></span>`;
  }

  function fmtTime(iso) {
    if (!iso) return "â€”";
    try {
      const d = new Date(iso);
      return d.toLocaleString("de-DE", { hour: "2-digit", minute: "2-digit", second: "2-digit", day: "2-digit", month: "2-digit" });
    } catch {
      return iso;
    }
  }

  async function fetchDevices() {
    setConn("Lade GerÃ¤teâ€¦", true);
    const res = await fetch(`${API_BASE}/devices`);
    if (!res.ok) throw new Error(`GET /devices â†’ HTTP ${res.status}`);
    return await res.json();
  }

  function clearRows() {
    rowsEl.innerHTML = "";
  }

  function addRow(dev) {
    const tr = document.createElement("tr");

    const local = {
      // lokale Status-Sicht (damit wir target-presses korrekt berechnen)
      status: Number(dev.status ?? dev.current_status ?? 0)
    };

    // --- Spalte 1: GerÃ¤t
    const td1 = document.createElement("td");
    td1.innerHTML = `
      <div class="rowTitle">${dev.id}</div>
      <div class="muted">${dev.name ?? ""}</div>
      <div class="muted">${dev.location ?? ""}</div>
    `;
    tr.appendChild(td1);

    // --- Spalte 2: Status
    const td2 = document.createElement("td");
    const statusBadge = document.createElement("div");
    statusBadge.className = "statusBadge";
    statusBadge.innerHTML = `
      <span>${statusToDots(local.status)}</span>
      <span>${statusToLabel(local.status)}</span>
    `;

    const last = document.createElement("div");
    last.className = "muted";
    last.textContent = `Letztes Update: ${fmtTime(dev.lastUpdate ?? dev.last_update)}`;

    td2.appendChild(statusBadge);
    td2.appendChild(last);
    tr.appendChild(td2);

    // --- Spalte 3: Key Input
    const td3 = document.createElement("td");
    const keyInput = document.createElement("input");
    keyInput.className = "keyInput";
    keyInput.type = "password";
    keyInput.placeholder = "X-Device-Key (pro GerÃ¤t)";
    td3.appendChild(keyInput);
    tr.appendChild(td3);

    // --- Spalte 4: Aktionen
    const td4 = document.createElement("td");
    const btnGroup = document.createElement("div");
    btnGroup.className = "btnGroup";

    const msg = document.createElement("div");
    msg.className = "statusMsg";

    function setLoading(isLoading) {
      [btnPress, btnRed, btnToday, btnMulti].forEach(b => b.disabled = isLoading);
      btnReload.disabled = isLoading;
    }

    async function pressOnce() {
      const key = keyInput.value.trim();
      if (!key) throw new Error("Bitte X-Device-Key eingeben.");

      const res = await fetch(`${API_BASE}/devices/${encodeURIComponent(dev.id)}/press`, {
        method: "POST",
        headers: {
          "X-Device-Key": key
        }
      });
      if (!res.ok) throw new Error(`POST /press â†’ HTTP ${res.status}`);
      const data = await res.json();

      // lokales Modell aktualisieren
      local.status = Number(data.status);

      // UI aktualisieren
      statusBadge.innerHTML = `
        <span>${statusToDots(local.status)}</span>
        <span>${statusToLabel(local.status)}</span>
      `;
      last.textContent = `Letztes Update: ${fmtTime(data.lastUpdate)}`;

      return data;
    }

    async function pressToTarget(targetStatus, label) {
      setLoading(true);
      msg.className = "statusMsg";
      msg.textContent = `Sende ${label} (Ã¼ber Press)â€¦`;

      try {
        const presses = (targetStatus - local.status + 3) % 3;
        let lastData = null;

        for (let i = 0; i < presses; i++) {
          lastData = await pressOnce();
        }

        msg.className = "statusMsg ok";
        if (presses === 0) {
          msg.textContent = `OK (bereits: ${label})`;
        } else {
          msg.textContent = `OK (${label})`;
        }
      } catch (e) {
        console.error(e);
        msg.className = "statusMsg err";
        msg.textContent = `Fehler: ${e.message}`;
      } finally {
        setLoading(false);
      }
    }

    // Buttons
    const btnPress = document.createElement("button");
    btnPress.className = "btn primary";
    btnPress.textContent = "PRESS (wie Hardware)";
    btnPress.addEventListener("click", async () => {
      setLoading(true);
      msg.className = "statusMsg";
      msg.textContent = "Sende PRESSâ€¦";
      try {
        const data = await pressOnce();
        msg.className = "statusMsg ok";
        msg.textContent = `OK (Status jetzt: ${data.status})`;
      } catch (e) {
        console.error(e);
        msg.className = "statusMsg err";
        msg.textContent = `Fehler: ${e.message}`;
      } finally {
        setLoading(false);
      }
    });

    const btnRed = document.createElement("button");
    btnRed.className = "btn";
    btnRed.textContent = "ðŸ”´ Rot";
    btnRed.addEventListener("click", () => pressToTarget(0, "keine VerfÃ¼gbarkeit"));

    const btnToday = document.createElement("button");
    btnToday.className = "btn";
    btnToday.textContent = "ðŸŸ¢ Heute";
    btnToday.addEventListener("click", () => pressToTarget(1, "VerfÃ¼gbarkeit heute"));

    const btnMulti = document.createElement("button");
    btnMulti.className = "btn";
    btnMulti.textContent = "ðŸŸ¢ðŸŸ¢ Mehrere Tage";
    btnMulti.addEventListener("click", () => pressToTarget(2, "VerfÃ¼gbarkeit mehrere Tage"));

    btnGroup.appendChild(btnPress);
    btnGroup.appendChild(btnRed);
    btnGroup.appendChild(btnToday);
    btnGroup.appendChild(btnMulti);

    td4.appendChild(btnGroup);
    td4.appendChild(msg);
    tr.appendChild(td4);

    rowsEl.appendChild(tr);
  }

  async function reload() {
    try {
      setConn("Lade GerÃ¤teâ€¦", true);
      clearRows();
      const devices = await fetchDevices();

      if (!Array.isArray(devices) || devices.length === 0) {
        rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Keine GerÃ¤te vorhanden.</td></tr>`;
        setConn("OK (0 GerÃ¤te)", true);
        return;
      }

      devices.forEach(addRow);
      setConn(`OK (${devices.length} GerÃ¤te)`, true);
    } catch (e) {
      console.error(e);
      rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Fehler beim Laden: ${e.message}</td></tr>`;
      setConn("Fehler", false);
    }
  }

  btnReload.addEventListener("click", reload);

  // Auto-load beim Start
  reload();
</script>
</body>
</html>
